"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var router_1 = require("@angular/router");
var nativescript_mqtt_1 = require("nativescript-mqtt");
var application_settings_1 = require("application-settings");
var element_registry_1 = require("nativescript-angular/element-registry");
element_registry_1.registerElement("Fab", function () { return require("nativescript-floatingactionbutton").Fab; });
var restApi_service_1 = require("../../restApi.service");
var commonLib_1 = require("../../commonLib");
var Conversation = (function () {
    function Conversation(route, _router, restApi, zone) {
        this.route = route;
        this._router = _router;
        this.restApi = restApi;
        this.zone = zone;
        this.devKey = '';
        this.convos = [];
        this.newConvos = [];
        this.userDetails = [];
        this.groupFeeds = [];
        this.dispName = [];
        this.profilePic = [];
        this.groupDetails = [];
        this.token = application_settings_1.getString("userKey");
        this.mqtt_host = "apps-test.applozic.com";
        this.mqtt_port = 15677;
        this.mqtt_useSSL = true;
        this.mqtt_path = "/ws";
        this.mqtt_username = "guest";
        this.mqtt_password = "guest";
        this.mqtt_topic = this.token;
        this.options = {
            host: this.mqtt_host,
            port: this.mqtt_port,
            useSSL: this.mqtt_useSSL,
            path: this.mqtt_path
        };
        this.mqtt_client = new nativescript_mqtt_1.MQTTClient(this.options);
        this.account = {};
        this.stopCalls = false;
        this.fabTap = function (args) {
            this._router.navigate(["/startNew", this.devKey]);
            console.log('tapped');
        };
        this.timeSince = commonLib_1.getTime;
        this.setupHandlers();
    }
    Conversation.prototype.ngOnInit = function () {
        var _this = this;
        console.log("conversations onInit");
        this.devKey = this.route.snapshot.params['devKey'];
        var data = {
            devKey: this.devKey
        };
        this.restApi.convoList(data).subscribe(function (res) {
            console.log("res");
            _this.convos = res.message;
            _this.userDetails = res.userDetails;
            _this.groupFeeds = res.groupFeeds;
            commonLib_1.convoDetails(_this.userDetails, _this.groupFeeds);
            _this.dispName = commonLib_1.dispName;
            _this.profilePic = commonLib_1.profilePic;
            _this.groupDetails = commonLib_1.groupDetails;
            console.log(_this.groupFeeds.length);
            console.log(commonLib_1.groupDetails.length);
        }, function (err) {
            console.log("err");
            console.log(err);
        });
        this.connect();
    };
    Conversation.prototype.connect = function () {
        try {
            this.mqtt_client.connect(this.mqtt_username, this.mqtt_password);
            console.log("Connencting...");
        }
        catch (e) {
            console.log("Caught error IN connect: " + e);
        }
    };
    Conversation.prototype.subscribe = function () {
        try {
            this.mqtt_client.subscribe(this.mqtt_topic);
            console.log("Subscribed...");
        }
        catch (e) {
            console.log("Caught error In subscribe: " + e);
        }
    };
    Conversation.prototype.setupHandlers = function () {
        var _this = this;
        this.mqtt_client.onConnectionFailure.on(function (err) {
            console.log("Connection failed: ");
            console.dir(err);
        });
        this.mqtt_client.onConnectionSuccess.on(function () {
            console.log("Connected successfully!");
            _this.subscribe();
        });
        this.mqtt_client.onConnectionLost.on(function (err) {
            console.log("Connection lost: " + err);
        });
        this.mqtt_client.onMessageArrived.on(function (message) {
            console.log("Message received: ");
            console.log(message.payload);
            var newMessage = JSON.parse(message.payload);
            var newConvos = _this.convos;
            for (var i = 0; i < newConvos.length; i++) {
                if (newConvos[i].to == newMessage.message.to) {
                    console.dir(newConvos[i]);
                    newConvos[i] = newMessage.message;
                    _this.convos = newConvos;
                    //  delete newConvos[i];
                    //  let msg = [] ;
                    //  msg[0]  = newMessage.message;
                    //  newConvos = msg.concat(newConvos);
                    //  newConvos.push(newMessage.message);
                    console.dir(newConvos[i]);
                    //  this.convos[i] = newMessage.message;
                }
            }
        });
    };
    Conversation.prototype.chatOpen = function (user) {
        var id = "userId";
        var whose = user.to;
        if (user.groupId) {
            id = "groupId";
            whose = user.groupId;
        }
        this._router.navigate(["/chatWith", id, whose]);
    };
    Conversation.prototype.loadMoreItems = function () {
        var _this = this;
        if (this.stopCalls) {
            return;
        }
        var endTime = this.convos[this.convos.length - 1].createdAtTime;
        this.devKey = this.route.snapshot.params['devKey'];
        var that = this;
        var data = {
            devKey: this.devKey,
            endTime: endTime
        };
        console.log("Loaded");
        this.restApi.convoList(data).subscribe(function (res) {
            _this.newConvos = res.message;
            _this.userDetails = res.userDetails;
            _this.groupFeeds = res.groupFeeds;
            console.dir(_this.newConvos.length);
            that.stopCalls = (_this.newConvos.length == 0);
            commonLib_1.convoDetails(_this.userDetails, _this.groupFeeds);
            _this.dispName = commonLib_1.dispName;
            _this.profilePic = commonLib_1.profilePic;
            _this.groupDetails = commonLib_1.groupDetails;
            _this.convos = _this.convos.concat(_this.newConvos);
        }, function (err) {
            console.log("err");
            console.log(err);
        });
    };
    Conversation.prototype.logOut = function () {
        this.isTurnedOn = application_settings_1.getBoolean("isTurnedOn");
        if (this.isTurnedOn) {
            application_settings_1.setBoolean("isTurnedOn", false);
            this.account = {};
            application_settings_1.setString("account", JSON.stringify(this.account));
            this._router.navigate(["/login"]);
        }
    };
    return Conversation;
}());
Conversation = __decorate([
    core_1.Component({
        selector: "conversation",
        templateUrl: "pages/conversations/conversation.html",
        styleUrls: ["pages/conversations/conversation.css"]
    }),
    __metadata("design:paramtypes", [router_1.ActivatedRoute, router_1.Router, restApi_service_1.RestApiService, core_1.NgZone])
], Conversation);
exports.Conversation = Conversation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVyc2F0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnZlcnNhdGlvbi5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBcUU7QUFFckUsMENBQXVFO0FBRXZFLHVEQUE2QztBQUk3Qyw2REFVOEI7QUFJOUIsMEVBQXdFO0FBQ3hFLGtDQUFlLENBQUMsS0FBSyxFQUFFLGNBQU0sT0FBQSxPQUFPLENBQUMsbUNBQW1DLENBQUMsQ0FBQyxHQUFHLEVBQWhELENBQWdELENBQUMsQ0FBQztBQUUvRSx5REFBdUQ7QUFDdkQsNkNBQTRGO0FBTzVGLElBQWEsWUFBWTtJQXFDckIsc0JBQW9CLEtBQXFCLEVBQVUsT0FBZSxFQUFTLE9BQXVCLEVBQVUsSUFBWTtRQUFwRyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUFVLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFBUyxZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQUFVLFNBQUksR0FBSixJQUFJLENBQVE7UUFwQ3hILFdBQU0sR0FBRyxFQUFFLENBQUM7UUFDWixXQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ1osY0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNmLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLGVBQVUsR0FBRyxFQUFFLENBQUM7UUFDaEIsYUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNkLGVBQVUsR0FBRyxFQUFFLENBQUM7UUFDaEIsaUJBQVksR0FBRyxFQUFFLENBQUM7UUFFbEIsVUFBSyxHQUFHLGdDQUFTLENBQUMsU0FBUyxDQUFDLENBQUE7UUFFNUIsY0FBUyxHQUFXLHdCQUF3QixDQUFDO1FBQzdDLGNBQVMsR0FBVyxLQUFLLENBQUM7UUFDMUIsZ0JBQVcsR0FBWSxJQUFJLENBQUM7UUFDNUIsY0FBUyxHQUFXLEtBQUssQ0FBQztRQUMxQixrQkFBYSxHQUFXLE9BQU8sQ0FBQztRQUNoQyxrQkFBYSxHQUFXLE9BQU8sQ0FBQztRQUNoQyxlQUFV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Q2pDLEtBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3JELENBQUMsRUFDRCxVQUFBLEdBQUc7WUFDQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25CLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUE7SUFDUixDQUFDO0lBT0QsNkJBQU0sR0FBTjtRQUNFLElBQUksQ0FBQyxVQUFVLEdBQUcsaUNBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUMzQyxFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUEsQ0FBQztZQUNoQixpQ0FBVSxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoQyxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNsQixnQ0FBUyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUUsQ0FBQTtRQUN0QyxDQUFDO0lBQ0gsQ0FBQztJQUVILG1CQUFDO0FBQUQsQ0FBQyxBQTFMRCxJQTBMQztBQTFMWSxZQUFZO0lBTHhCLGdCQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsY0FBYztRQUN4QixXQUFXLEVBQUUsdUNBQXVDO1FBQ3BELFNBQVMsRUFBRSxDQUFDLHNDQUFzQyxDQUFDO0tBQ3BELENBQUM7cUNBc0M2Qix1QkFBYyxFQUFtQixlQUFNLEVBQWtCLGdDQUFjLEVBQWdCLGFBQU07R0FyQy9HLFlBQVksQ0EwTHhCO0FBMUxZLG9DQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIE9uRGVzdHJveSwgTmdab25lIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEV2ZW50RGF0YSB9IGZyb20gJ2RhdGEvb2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBSb3V0ZXIsIEFjdGl2YXRlZFJvdXRlLCBQYXJhbXMsIERhdGEgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuXG5pbXBvcnQge01RVFRDbGllbnR9IGZyb20gXCJuYXRpdmVzY3JpcHQtbXF0dFwiO1xuaW1wb3J0IHtNZXNzYWdlfSBmcm9tIFwibmF0aXZlc2NyaXB0LW1xdHQvY29tbW9uXCI7XG5cblxuaW1wb3J0IHtcbiAgICBnZXRCb29sZWFuLFxuICAgIHNldEJvb2xlYW4sXG4gICAgZ2V0TnVtYmVyLFxuICAgIHNldE51bWJlcixcbiAgICBnZXRTdHJpbmcsXG4gICAgc2V0U3RyaW5nLFxuICAgIGhhc0tleSxcbiAgICByZW1vdmUsXG4gICAgY2xlYXJcbn0gZnJvbSBcImFwcGxpY2F0aW9uLXNldHRpbmdzXCI7XG5cblxuXG5pbXBvcnQgeyByZWdpc3RlckVsZW1lbnQgfSBmcm9tIFwibmF0aXZlc2NyaXB0LWFuZ3VsYXIvZWxlbWVudC1yZWdpc3RyeVwiO1xucmVnaXN0ZXJFbGVtZW50KFwiRmFiXCIsICgpID0+IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtZmxvYXRpbmdhY3Rpb25idXR0b25cIikuRmFiKTtcblxuaW1wb3J0IHsgUmVzdEFwaVNlcnZpY2UgfSBmcm9tICcuLi8uLi9yZXN0QXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgZGlzcE5hbWUsIHByb2ZpbGVQaWMsIGdyb3VwRGV0YWlscywgY29udm9EZXRhaWxzLCBnZXRUaW1lIH0gZnJvbSAnLi4vLi4vY29tbW9uTGliJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiBcImNvbnZlcnNhdGlvblwiLFxuICB0ZW1wbGF0ZVVybDogXCJwYWdlcy9jb252ZXJzYXRpb25zL2NvbnZlcnNhdGlvbi5odG1sXCIsXG4gIHN0eWxlVXJsczogW1wicGFnZXMvY29udmVyc2F0aW9ucy9jb252ZXJzYXRpb24uY3NzXCJdXG59KVxuZXhwb3J0IGNsYXNzIENvbnZlcnNhdGlvbiB7XG4gICAgZGV2S2V5ID0gJyc7XG4gICAgY29udm9zID0gW107XG4gICAgbmV3Q29udm9zID0gW107XG4gICAgdXNlckRldGFpbHMgPSBbXTtcbiAgICBncm91cEZlZWRzID0gW107XG4gICAgZGlzcE5hbWUgPSBbXTtcbiAgICBwcm9maWxlUGljID0gW107XG4gICAgZ3JvdXBEZXRhaWxzID0gW107XG5cbiAgICB0b2tlbiA9IGdldFN0cmluZyhcInVzZXJLZXlcIilcblxuICAgIG1xdHRfaG9zdDogc3RyaW5nID0gXCJhcHBzLXRlc3QuYXBwbG96aWMuY29tXCI7XG4gICAgbXF0dF9wb3J0OiBudW1iZXIgPSAxNTY3NztcbiAgICBtcXR0X3VzZVNTTDogYm9vbGVhbiA9IHRydWU7XG4gICAgbXF0dF9wYXRoOiBzdHJpbmcgPSBcIi93c1wiO1xuICAgIG1xdHRfdXNlcm5hbWU6IHN0cmluZyA9IFwiZ3Vlc3RcIjtcbiAgICBtcXR0X3Bhc3N3b3JkOiBzdHJpbmcgPSBcImd1ZXN0XCI7XG4gICAgbXF0dF90b3BpYzogc3RyaW5nID0gdGhpcy50b2tlbjtcblxuICAgIG9wdGlvbnMgPSB7XG4gICAgICAgIGhvc3Q6IHRoaXMubXF0dF9ob3N0LFxuICAgICAgICBwb3J0OiB0aGlzLm1xdHRfcG9ydCxcbiAgICAgICAgdXNlU1NMOiB0aGlzLm1xdHRfdXNlU1NMLFxuICAgICAgICBwYXRoOiB0aGlzLm1xdHRfcGF0aFxuICAgIH07XG5cbiAgICBtcXR0X2NsaWVudDogTVFUVENsaWVudCA9IG5ldyBNUVRUQ2xpZW50KHRoaXMub3B0aW9ucyk7XG5cbiAgICBwcml2YXRlIHNvY2tldDogYW55O1xuXG4gICAgcHVibGljIGlzVHVybmVkT246IGJvb2xlYW47XG4gICAgcHVibGljIGFjY291bnQgPSB7fVxuXG4gICAgcHVibGljIHRpbWVTaW5jZTtcbiAgICBwdWJsaWMgc3RvcENhbGxzID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSwgcHJpdmF0ZSBfcm91dGVyOiBSb3V0ZXIsIHB1YmxpYyByZXN0QXBpOiBSZXN0QXBpU2VydmljZSwgcHJpdmF0ZSB6b25lOiBOZ1pvbmUpIHtcbiAgICAgICAgdGhpcy50aW1lU2luY2UgPSBnZXRUaW1lO1xuICAgICAgICB0aGlzLnNldHVwSGFuZGxlcnMoKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpe1xuICAgICAgICBjb25zb2xlLmxvZyhcImNvbnZlcnNhdGlvbnMgb25Jbml0XCIpO1xuICAgICAgICB0aGlzLmRldktleSA9IHRoaXMucm91dGUuc25hcHNob3QucGFyYW1zWydkZXZLZXknXTtcbiAgICAgICAgbGV0IGRhdGEgPSB7XG4gICAgICAgICAgICBkZXZLZXkgOiB0aGlzLmRldktleVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZXN0QXBpLmNvbnZvTGlzdChkYXRhKS5zdWJzY3JpYmUoIHJlcyA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInJlc1wiKTtcbiAgICAgICAgICAgIHRoaXMuY29udm9zID0gcmVzLm1lc3NhZ2U7XG4gICAgICAgICAgICB0aGlzLnVzZXJEZXRhaWxzID0gcmVzLnVzZXJEZXRhaWxzO1xuICAgICAgICAgICAgdGhpcy5ncm91cEZlZWRzID0gcmVzLmdyb3VwRmVlZHM7XG5cbiAgICAgICAgICAgIGNvbnZvRGV0YWlscyh0aGlzLnVzZXJEZXRhaWxzLCB0aGlzLmdyb3VwRmVlZHMpO1xuICAgICAgICAgICAgdGhpcy5kaXNwTmFtZSA9IGRpc3BOYW1lO1xuICAgICAgICAgICAgdGhpcy5wcm9maWxlUGljID0gIHByb2ZpbGVQaWM7XG4gICAgICAgICAgICB0aGlzLmdyb3VwRGV0YWlscyA9IGdyb3VwRGV0YWlscztcblxuICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5ncm91cEZlZWRzLmxlbmd0aCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhncm91cERldGFpbHMubGVuZ3RoKTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyXCIpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLmNvbm5lY3QoKTtcblxuICAgIH1cblxuICAgIGNvbm5lY3QoKSA6IHZvaWQge1xuICAgICAgICB0cnl7XG4gICAgICAgICAgICB0aGlzLm1xdHRfY2xpZW50LmNvbm5lY3QodGhpcy5tcXR0X3VzZXJuYW1lLCB0aGlzLm1xdHRfcGFzc3dvcmQpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJDb25uZW5jdGluZy4uLlwiKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJDYXVnaHQgZXJyb3IgSU4gY29ubmVjdDogXCIgKyBlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN1YnNjcmliZSgpIDogdm9pZCB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLm1xdHRfY2xpZW50LnN1YnNjcmliZSh0aGlzLm1xdHRfdG9waWMpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTdWJzY3JpYmVkLi4uXCIpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNhdWdodCBlcnJvciBJbiBzdWJzY3JpYmU6IFwiICsgZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXR1cEhhbmRsZXJzKCkgOiB2b2lkIHtcbiAgICAgICAgdGhpcy5tcXR0X2NsaWVudC5vbkNvbm5lY3Rpb25GYWlsdXJlLm9uKChlcnIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ29ubmVjdGlvbiBmYWlsZWQ6IFwiKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGlyKGVycik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubXF0dF9jbGllbnQub25Db25uZWN0aW9uU3VjY2Vzcy5vbigoKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNvbm5lY3RlZCBzdWNjZXNzZnVsbHkhXCIpO1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5tcXR0X2NsaWVudC5vbkNvbm5lY3Rpb25Mb3N0Lm9uKChlcnIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ29ubmVjdGlvbiBsb3N0OiBcIiArIGVycik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubXF0dF9jbGllbnQub25NZXNzYWdlQXJyaXZlZC5vbigobWVzc2FnZTogTWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJNZXNzYWdlIHJlY2VpdmVkOiBcIiApO1xuICAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UucGF5bG9hZCk7XG4gICAgICAgICAgICAgbGV0IG5ld01lc3NhZ2UgPSBKU09OLnBhcnNlKG1lc3NhZ2UucGF5bG9hZCk7XG4gICAgICAgICAgICAgbGV0IG5ld0NvbnZvcyA9IHRoaXMuY29udm9zO1xuICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPG5ld0NvbnZvcy5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICAgICAgIGlmKG5ld0NvbnZvc1tpXS50byA9PSBuZXdNZXNzYWdlLm1lc3NhZ2UudG8pe1xuICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kaXIobmV3Q29udm9zW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgIG5ld0NvbnZvc1tpXSA9IG5ld01lc3NhZ2UubWVzc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29udm9zID0gbmV3Q29udm9zO1xuICAgICAgICAgICAgICAgICAgICAvLyAgZGVsZXRlIG5ld0NvbnZvc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgLy8gIGxldCBtc2cgPSBbXSA7XG4gICAgICAgICAgICAgICAgICAgIC8vICBtc2dbMF0gID0gbmV3TWVzc2FnZS5tZXNzYWdlO1xuICAgICAgICAgICAgICAgICAgICAvLyAgbmV3Q29udm9zID0gbXNnLmNvbmNhdChuZXdDb252b3MpO1xuICAgICAgICAgICAgICAgICAgICAvLyAgbmV3Q29udm9zLnB1c2gobmV3TWVzc2FnZS5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGlyKG5ld0NvbnZvc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIC8vICB0aGlzLmNvbnZvc1tpXSA9IG5ld01lc3NhZ2UubWVzc2FnZTtcbiAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgY2hhdE9wZW4odXNlcil7XG4gICAgbGV0IGlkID0gXCJ1c2VySWRcIjtcbiAgICBsZXQgd2hvc2UgPSB1c2VyLnRvO1xuICAgIGlmKHVzZXIuZ3JvdXBJZCl7XG4gICAgICAgIGlkID0gXCJncm91cElkXCI7XG4gICAgICAgIHdob3NlID0gdXNlci5ncm91cElkO1xuICAgIH1cbiAgICB0aGlzLl9yb3V0ZXIubmF2aWdhdGUoW1wiL2NoYXRXaXRoXCIsaWQsd2hvc2VdKTtcbiAgfVxuXG4gIGxvYWRNb3JlSXRlbXMoKXtcbiAgICAgIGlmICh0aGlzLnN0b3BDYWxscykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBsZXQgZW5kVGltZSA9IHRoaXMuY29udm9zW3RoaXMuY29udm9zLmxlbmd0aC0xXS5jcmVhdGVkQXRUaW1lO1xuICAgICAgdGhpcy5kZXZLZXkgPSB0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmFtc1snZGV2S2V5J107XG4gICAgICBsZXQgdGhhdCA9IHRoaXM7XG4gICAgICAgIGxldCBkYXRhID0ge1xuICAgICAgICAgICAgZGV2S2V5IDogdGhpcy5kZXZLZXksXG4gICAgICAgICAgICBlbmRUaW1lOiBlbmRUaW1lXG4gICAgICAgIH1cbiAgICAgIGNvbnNvbGUubG9nKFwiTG9hZGVkXCIpO1xuICAgICAgdGhpcy5yZXN0QXBpLmNvbnZvTGlzdChkYXRhKS5zdWJzY3JpYmUoIHJlcyA9PiB7XG4gICAgICAgICAgICB0aGlzLm5ld0NvbnZvcyA9IHJlcy5tZXNzYWdlO1xuICAgICAgICAgICAgdGhpcy51c2VyRGV0YWlscyA9IHJlcy51c2VyRGV0YWlscztcbiAgICAgICAgICAgIHRoaXMuZ3JvdXBGZWVkcyA9IHJlcy5ncm91cEZlZWRzO1xuXG4gICAgICAgICAgICBjb25zb2xlLmRpcih0aGlzLm5ld0NvbnZvcy5sZW5ndGgpO1xuICAgICAgICAgICAgdGhhdC5zdG9wQ2FsbHMgPSAodGhpcy5uZXdDb252b3MubGVuZ3RoID09IDApO1xuICAgICAgICAgICAgY29udm9EZXRhaWxzKHRoaXMudXNlckRldGFpbHMsIHRoaXMuZ3JvdXBGZWVkcyk7XG4gICAgICAgICAgICB0aGlzLmRpc3BOYW1lID0gZGlzcE5hbWU7XG4gICAgICAgICAgICB0aGlzLnByb2ZpbGVQaWMgPSAgcHJvZmlsZVBpYztcbiAgICAgICAgICAgIHRoaXMuZ3JvdXBEZXRhaWxzID0gZ3JvdXBEZXRhaWxzO1xuICAgICAgICAgICAgdGhpcy5jb252b3MgPSB0aGlzLmNvbnZvcy5jb25jYXQodGhpcy5uZXdDb252b3MpO1xuICAgICAgICB9LFxuICAgICAgICBlcnIgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJlcnJcIik7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICB9KVxuICB9XG5cbiAgZmFiVGFwID0gZnVuY3Rpb24oYXJncykge1xuICAgICB0aGlzLl9yb3V0ZXIubmF2aWdhdGUoW1wiL3N0YXJ0TmV3XCIsdGhpcy5kZXZLZXldKTtcbiAgICAgY29uc29sZS5sb2coJ3RhcHBlZCcpO1xuICB9XG5cbiAgbG9nT3V0KCl7XG4gICAgdGhpcy5pc1R1cm5lZE9uID0gZ2V0Qm9vbGVhbihcImlzVHVybmVkT25cIik7XG4gICAgaWYodGhpcy5pc1R1cm5lZE9uKXtcbiAgICAgICAgc2V0Qm9vbGVhbihcImlzVHVybmVkT25cIiwgZmFsc2UpO1xuICAgICAgICB0aGlzLmFjY291bnQgPSB7fTtcbiAgICAgICAgc2V0U3RyaW5nKFwiYWNjb3VudFwiLCBKU09OLnN0cmluZ2lmeSh0aGlzLmFjY291bnQpKTtcbiAgICAgICAgdGhpcy5fcm91dGVyLm5hdmlnYXRlKFtcIi9sb2dpblwiXSApXG4gICAgfVxuICB9XG5cbn1cbiJdfQ==